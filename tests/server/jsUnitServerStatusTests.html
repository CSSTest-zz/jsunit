<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">

<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <title>JsUnit Server Status Tests</title>
    <link rel="stylesheet" type="text/css" href="../../css/jsUnitStyle.css">
    <script language="JavaScript" type="text/javascript" src="../../app/jsUnitCore.js"></script>
    <script language="JavaScript" type="text/javascript" src="../../app/server/jsUnitServerStatus.js"></script>
    <script language="JavaScript" type="text/javascript" src="../../app/jsUnitAjax.js"></script>
    <script language="JavaScript" type="text/javascript" src="../../app/jsUnitMockTimeout.js"></script>
    <script language="JavaScript" type="text/javascript">

        var messageString;
        var updateServerStatusDivCalled;
        var initialTimeoutsMade;
        var serverStatusUpdater;

        function setUp() {
            messageString = null;
            updateServerStatusDivCalled = false;
            initialTimeoutsMade = Clock.timeoutsMade;
            serverStatusUpdater = new ServerStatusUpdater();
        }

        function testAskServerForStatus() {
            serverStatusUpdater.askServerForStatus();
            assertEquals("GET", serverStatusUpdater.request.method);
            assertEquals("serverstatus", serverStatusUpdater.request.url);
            assertTrue(serverStatusUpdater.request.isAsync);
            assertUndefined(serverStatusUpdater.request.userName);
            assertUndefined(serverStatusUpdater.request.password);

            assertTrue(serverStatusUpdater.request.sendCalled);
            assertNull(serverStatusUpdater.request.data);

            assertEquals(serverStatusRequestStateChanged, serverStatusUpdater.request.onreadystatechange);
            assertFalse(updateServerStatusDivCalled);
        }

        function testReceiveBadResponse() {
            serverStatusUpdater.request = new MockXmlHttpRequest();
            serverStatusUpdater.request.readyState = 4;
            serverStatusUpdater.request.status = 404;
            serverStatusUpdater.requestStateChanged();
            assertFalse(updateServerStatusDivCalled);
            assertEquals(initialTimeoutsMade + 1, Clock.timeoutsMade);
            assertEquals("serverStatusUpdater.askServerForStatus()", Clock.scheduledFunctions[initialTimeoutsMade + 1].funcToCall);
        }

        function testStateChangedNotReady() {
            serverStatusUpdater.request = new MockXmlHttpRequest();
            serverStatusUpdater.request.readyState = 1;
            serverStatusUpdater.requestStateChanged();
            assertFalse(updateServerStatusDivCalled);
            assertEquals(initialTimeoutsMade, Clock.timeoutsMade);
        }

        function testReceiveServerStatus() {
            receiveValidServerStatus("server started|test run requested");
            assertEquals(initialTimeoutsMade + 1, Clock.timeoutsMade);
            assertEquals("serverStatusUpdater.askServerForStatus()", Clock.scheduledFunctions[initialTimeoutsMade + 1].funcToCall);
            assertTrue(updateServerStatusDivCalled);
            assertEquals("server started|test run requested", messageString);
        }

        function receiveValidServerStatus(message) {
            serverStatusUpdater.request = new MockXmlHttpRequest();
            serverStatusUpdater.request.readyState = 4;
            serverStatusUpdater.request.status = 200;
            serverStatusUpdater.request.responseText = message;
            serverStatusUpdater.requestStateChanged();
        }

        function updateServerStatusDiv(messageString) {
            updateServerStatusDivCalled = true;
            this.messageString = messageString;
        }

    </script>
</head>

<body>
<h1>JsUnit Server Status Tests</h1>

<p>This page contains tests for the retrieval and displaying of the JsUnit server status.</p>
</body>
</html>
